<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Index</title>
    <link rel="stylesheet" href="assets/css/bootstrap.min.css?verisn=" + Math.ceil(Math.random() * 1010) />
    <link rel="stylesheet" href="assets/css/global.css?verisn=" + Math.ceil(Math.random() * 1010) />
    <link rel="stylesheet" href="assets/css/font-awesome.min.css?verisn=" + Math.ceil(Math.random() * 1010) />
    <link rel="stylesheet" href="assets/css/AdminLTE.min.css?verisn=" + Math.ceil(Math.random() * 1010) />
    <link rel="stylesheet" href="assets/css/skins/skin-black.min.css?verisn=" + Math.ceil(Math.random() * 1010) />
    <link rel="stylesheet" href="assets/css/index.css?verisn=" + Math.ceil(Math.random() * 1010)>
    <link rel="stylesheet" href="assets/css/topology.css?verisn=" + Math.ceil(Math.random() * 1010)>
</head>

<body class="skin-black sidebar-open sidebar-mini">
    <div class="wrapper" id="Heliosload">

        <!-- 页头 -->
        <div id="comp-header" class="main-header" style="position: relative; z-index: 99;">
            <el-main-header></el-main-header>
        </div>
        <!-- 页头end -->

        <!-- 侧边栏导航 -->
        <div id="comp-sidebar">11111
          <!--   <el-main-sidebar v-bind:siteno="sitenodata"></el-main-sidebar> -->
            <el-index-slidebar></el-index-slidebar>
        </div>
        <!-- 侧边栏导航 end -->

        <!-- 内容区域 -->
        <transition name="slide-fade">
            <div class="content-wrapper" id="content">
                <!-- 内容头部面包屑 -->

                <!-- 主要内容显示 -->
                <section class="content container-fluid" id="MainContext">
                    <div class="col-md-12 canbox">
                        <div class="col-md-4 cantips">
                            <div style="float: right;">
                                <form @submit.prevent="onSubmit" id="fileForm">
                                    <div style="float: left; margin-right: 5px; cursor: pointer;">
                                        <a href="javascript:void(0);" class="a-upload">
                                            <input type="file" value="Select the file" id="files" @change="fileImport">Update background
                                        </a>
                                    </div>
                                </form>

                                <div class="updatetopology">
                                    <el-button :disabled="!Read" type="success" @click="UpdateTopology">Update Topology</el-button>
                                </div>

                                <el-button :disabled="!Read" type="button" @click="SetCoordinates">Save the coordinates</el-button>
                            </div>
                            <!-- <div style="float: right;" title="开启定时">
                                <el-switch v-model="canMove">
                                </el-switch>
                            </div> -->
                        </div>
                        <canvas id="canvas" width="1100" height="1000">

                        </canvas>

                    </div>

                </section>
            </div>
            <!-- 内容区域 -->
        </transition>
    </div>






    <script type="text/javascript">
        //动态版本
        document.write('<script src="assets/js/jquery.js?v=' + (new Date()).getTime() + '"><\/script>');
        document.write('<script src="assets/js/jtopo-0.4.8-min.js?v=' + (new Date()).getTime() + '"><\/script>');
        document.write('<script src="assets/js/toolbar.js?v=' + (new Date()).getTime() + '"><\/script>');
        document.write('<script src="assets/js/toolbar.js?v=' + (new Date()).getTime() + '"><\/script>');
        document.write('<script src="assets/js/FileSaver.min.js?v=' + (new Date()).getTime() + '"><\/script>');
        document.write('<script src="assets/js/vue.js?v=' + (new Date()).getTime() + '"><\/script>');
        document.write('<script src="assets/js/index.js?v=' + (new Date()).getTime() + '"><\/script>');
        document.write('<script src="assets/js/comment.js?v=' + (new Date()).getTime() + '"><\/script>');
    </script>

    <script>
        var vm = this;
        var addrStation;
        var Helios;
        var num = 0;
        var canvas, stage, scene;
        let TopoNull = (localStorage.getItem("TopoNull"));

        var g_sitesNode = {
            "sites": []
        };
        let data = {
            siteInfo: [],
            offset: 0,
            station: '',
            StationChoose: [],
            canMove: false,
            heliosTrue: [],
            Read: true,
            verisn: Math.ceil(Math.random() * 1010),
            heliosUser: heliosUser[0] == $session || heliosUser[2] == $session,
        };

        //数据为空坐标处理
        var CanvasWin_width, CanvasWin_height;
        CanvasWin_width = $("#content").width();
        CanvasWin_height = $("#content").height() - 50;


        //数据为空
        window.onresize = function () {
            canvas = document.getElementById("canvas");
            canvas.width = CanvasWin_width;
            canvas.height = CanvasWin_height;
        }



        var Helioscoordinates = {
            x: 10,
            y: 10,
            width: Number(CanvasWin_width) / 8,
            height: Number(CanvasWin_height) / 8,
            displacement: "",
            SETdisp: Number(localStorage.getItem("SETdisp")),
        };


        CanvasRenderingContext2D.prototype.wrapText = function (str, x, y) {
            var textArray = str.split('\n');
            if (textArray == undefined || textArray == null) return false;

            // console.log(textArray);

            var rowCnt = textArray.length;
            var i = 0,
                imax = rowCnt,
                maxLength = 0;
            maxText = textArray[0];
            for (; i < imax; i++) {
                var nowText = textArray[i],
                    textLength = nowText.length;
                if (textLength >= maxLength) {
                    maxLength = textLength;
                    maxText = nowText;
                }
            }
            var maxWidth = this.measureText(maxText).width;
            var lineHeight = this.measureText("元").width;
            this.fillStyle = '#eee'; //设置字体颜色
            this.font = "11px Verdana"; //设置字体大小
            x -= lineHeight * 2;
            for (var j = 0; j < textArray.length; j++) {
                var words = textArray[j];
                this.fillText(words, -(maxWidth / 2), y - textArray.length * lineHeight / 100);
                y += lineHeight;
            }
        };

        function Canvas_Init() {
            //初始化画布的值
            canvas = document.getElementById("canvas");
            stage = new JTopo.Stage(canvas);
            scene = new JTopo.Scene(stage);
            scene.mode = "select";
            scene.background = 'background.jpg?verisn=' + Math.ceil(Math.random() * 1010);
            /* scene.background = 'cgi-bin/background.jpg'; */
        }

        function GetStation(vue1) {
            var temp = [];
            var obj = {};
            var param = [];
            var data_site;
            var vue = vue1;
            /*  sessionStorage.getItem('sitelist'); */
            addrStation = {
                "datalist": []
            }

            FindSiteTask(vue);
            //设置站点  
            setInterval(function () {
                if (vue.canMove)
                    FindSiteTask(vue);
            }, 10000);

            /* for (var i = 1; i < addrStation.length; i++) {
                console.log(addrStation[i]);
                if (addrStation[i] == 0) {
                    break;
                }
                Site_processing(addrStation[i], vue);
            } */
        }
        //定时器
        function FindSiteTask(vue1) {
            num = 0;
            var vue = vue1;
            /*  var timer = setInterval(() => {
                    console.log(33);
                    num++;
                    console.log(addrStation[num]);
                    if (addrStation[num] == "0") {
                        window.clearInterval(timer);
                    }
                }, 1000); */
            //设置坐标
            Site_processing(addrStation[num], vue);

        }

        //远端机
        function DeviceDataPoll(status, site_no, devices, deviceList, length) {

            //近端机位数
            length == 0 ? length = 1 : length += 1;

            for (let i = 0; i < devices.length; i++) {
                //初始节点
                Helioscoordinates.displacement = (i <= 0) ? ii = 1 : ii = i + 1;

                let devObj = {};
                //远端机位数,设置位置处理  如果status ==0 选择用户设置坐标,否则 重新计算排列间距
                if (0 < status) {
                    devObj = {
                        "site_no": site_no,
                        "route": devices[i].route,
                        "routeLayer": RouteLayer(devices[i].route),
                        "device_id": devices[i].device_id,
                        "type": devices[i].type,
                        "x": devices[i].x,
                        "y": devices[i].y,
                        "alarm": "0",
                        "node": null
                    }
                } else {

                    devObj = {
                        "site_no": site_no,
                        "route": devices[i].route,
                        "routeLayer": RouteLayer(devices[i].route),
                        "device_id": devices[i].device_id,
                        "type": devices[i].type,
                        "x": (Helioscoordinates.width + (50 * Helioscoordinates.displacement)),
                        "y": (Helioscoordinates.height + length * 150), //上下间隔150
                        "alarm": "0",
                        "node": null
                    }
                }
                deviceList.push(devObj);
            }
            /*  console.log(status);
                console.log(site_no);
               console.log(devices); 
               console.log(Helioscoordinates); */
        }

        //初始化节点 //AU
        function SitesDataPoll(status, sites, siteList) {
            for (let i = 0; i < sites.length; i++) {
                Helioscoordinates.displacement = (i <= 0) ? ii = 1 : ii = i + 1;
                let devObj = {};
                devObj.site_no = sites[i].site_no;
                devObj.device_id = "0";

                //括普位置处理
                if (0 < status) {
                    devObj.x = sites[i].x;
                    devObj.y = sites[i].y;
                } else {
                    devObj.x = Helioscoordinates.width + (Helioscoordinates.displacement);
                    devObj.y = Helioscoordinates.height + (Helioscoordinates.displacement * 150); //上下间隔150
                }
                devObj.type = "AU";
                devObj.route = "0";
                devObj.routeLayer = 0;
                devObj.devices = [];
                devObj.node = null;
                devObj.alarm = "0";
                siteList.push(devObj);
                //远端机处理
                let devices = (sites[i].device);

                //TopoNull ==0 选择用户设置坐标,否则 重新计算排列间距
                DeviceDataPoll(TopoNull, devObj.site_no, devices, devObj.devices, i);

            }

            /*  console.log(status);
             console.log(sites);
             console.log(siteList);
             console.log(Helioscoordinates); */
        }

        function TopoNodeTextBr(node) {
            node.paintText = function (a) {
                a.beginPath();
                a.font = this.font;
                a.wrapText(this.text, this.height / 2, this.height);
                a.closePath();
            };
        }
        // 添加节点
        function DevicesTopoNodeAdd(devices) {

            for (let i = 0; i < devices.length; i++) {
                devices[i].node = new JTopo.Node(devices[i].type + "\n" + hex2int(devices[i].site_no) + "\n" + hex2int(
                    devices[i].device_id));
                TopoNodeTextBr(devices[i].node); //名称
                Site_Datefit(devices[i].node, devices[i]); //赋值，双击
                scene.add(devices[i].node);
            }
        }
        // 添加节点
        function SitesTopoNodeAdd(sites) {
            for (let i = 0; i < sites.length; i++) {
                sites[i].node = new JTopo.Node(sites[i].type + "\n" + hex2int(sites[i].site_no) + "\n" + hex2int(sites[
                    i].device_id));
                TopoNodeTextBr(sites[i].node); //名称
                Site_Datefit(sites[i].node, sites[i]); //赋值，双击
                scene.add(sites[i].node); //添加一个扩普节点

                DevicesTopoNodeAdd(sites[i].devices);
            }
        }

        //连线
        function TopoNodeLink(node1, node2) {
            let link = new JTopo.Link(node1, node2, "");
            link.direction = 'vertical' || 'horizontal';
            link.lineWidth = 3; // 线宽
            link.bundleOffset = 60; // 折线拐角处的长度
            link.bundleGap = 20; // 线条之间的间隔
            link.textOffsetY = 3; // 文本偏移量（向下3个像素）
            scene.add(link);
        }

        function RouteLayer(route) {
            let cnt = 0;
            let routeArr = route.split('');
            for (let i = 0; i < 8; i++) {
                if (routeArr[i] != "0") {
                    cnt += 1;
                } else {
                    break;
                }
            }
            return cnt;
        }
        //连线关系
        function FindTopoParentNode(devices, device) {
            let parentLayer = device.routeLayer - 1;
            let subRoute = device.route.substring(0, parentLayer);
            let subPRout;

            for (let i = 0; i < devices.length; i++) {
                subPRout = devices[i].route.substring(0, parentLayer);
                if (parentLayer == devices[i].routeLayer && subRoute == subPRout) {
                    return devices[i].node;
                }
            }

            return null;
        }

        function DevicesTopoNodeLink(devices, site_node) {
            let route, routeArr;
            let node;
            for (let i = 0; i < devices.length; i++) {
                route = devices[i].route.toString();
                routeArr = route.split('');
                if (1 == devices[i].routeLayer) {
                    TopoNodeLink(devices[i].node, site_node);
                } else {
                    parentNode = FindTopoParentNode(devices, devices[i]);
                    if (null != parentNode)
                        TopoNodeLink(devices[i].node, parentNode);
                }
            }
        }

        function SitesTopoNodeLink(sites) {
            for (let i = 0; i < sites.length; i++) {
                DevicesTopoNodeLink(sites[i].devices, sites[i].node);
            }
        }

        function DevicesAlarm(devices, devicesAlarm) {
            if (undefined == devicesAlarm) return;

            for (let i = 0; i < devices.length; i++) {
                devices[i].alarm = devicesAlarm[i].alarm;
            }
        }

        function SitesAlarm(sites, sitesAlarm) {
            if (undefined == sitesAlarm) return;

            for (let i = 0; i < sites.length; i++) {
                sites[i].alarm = sitesAlarm[i].alarm;
                DevicesAlarm(sites[i].devices, sitesAlarm[i].device);
            }
        }
        //设置坐标
        function Site_processing(stationInfo, vue1) {
            var SiteNode_exist = []; //已经存在站点存储
            let Herandom = Math.ceil(Math.random() * 1010);
            vue = vue1;
            //清空数组
            // SiteNode.splice(0, SiteNode.length);
            //获取站点信息
            //处理上传帧格式信息
            //页面初始化
            /*  util.getmods(0, function(data) { */
            var datalist = [];

            /*  $.ajax({
                 type: "GET",
                 url: "topology.json?verisn=" + Herandom,
                 dataType: "json",
                 success: function (data) { */
            let data = {
                "sites": [{
                    "site_no": "01343d18",
                    "x": "150",
                    "y": "277",
                    "status": 1,
                    "device": [{
                            "route": "20000000",
                            "device_id": "0200",
                            "type": "EU",
                            "x": "265",
                            "y": "277"
                        },
                        {
                            "route": "26000000",
                            "device_id": "0246",
                            "type": "RU",
                            "x": "375",
                            "y": "276"
                        }
                    ]
                }]
            }

            //数据为空
            var status = data.sites[0];
            if (undefined == status) {
                g_sitesNode.sites = ""; //数据源头处理
                //Device 入口处理
                //document.getElementsByClassName("canbox").style.display = "none";
                /* nodecomment[0].style.display = "none";
                      nodecleft[0].style.display = "none"; */
                var nodecomment = document.getElementById("MainContext").childNodes;
                var nodecleft = document.getElementById("comp-sidebar").childNodes;
                nodecomment[0].remove();
                nodecleft[0].remove();

                var appendHtml =
                    `<div class="nullempty" style="padding-top: 15%;text-align: center;">
                                <span class="icon iconfont icon-kongshuju" style="font-size: 71px;"></span>
                                 <h3 style="padding-top:9px">M-DOTS Topology  empty</h3>
                                 <button type="button" id="Update_Topology"  class="el-button el-button--success"><span>Update M-DOTS Topology</span></button>
                                </div>`;
                document.getElementById("content").innerHTML = appendHtml;
                document.getElementById("content").style.marginLeft = "0px";

                localStorage.setItem('TopoNull', 0);


                $("#Update_Topology").click(function () {
                    const h = toast.$createElement;
                    toast.$msgbox({
                        title: `Update M-DOTS Topology`,
                        message: h('p', null, [
                            h('span', null,
                                "Updating the topology"
                            ),
                            h('p', {
                                style: 'color: teal'
                            }, "Take five to ten seconds")
                        ]),

                        showCancelButton: true,
                        confirmButtonText: 'Confirm',
                        cancelButtonText: 'Cancel',
                        beforeClose: (action, instance, done) => {
                            if (action === 'confirm') {
                                instance.confirmButtonLoading = true;
                                instance.confirmButtonText =
                                    'The execution of...';
                                setTimeout(() => {
                                    done();
                                    setTimeout(() => {
                                        instance.confirmButtonLoading =
                                            false;
                                        var obj = {
                                            "data": JSON.stringify(
                                                [{
                                                    adr: 299,
                                                    value: "1"
                                                }]),
                                            "action": "SET"
                                        }
                                        util.postattrajax1(obj,
                                            function (data) {
                                                if (
                                                    "success" !=
                                                    data) {
                                                    toast.$message({
                                                        message: ' Error:' +
                                                            data
                                                            .message,
                                                        type: 'error',
                                                        showClose: true,
                                                        offset: 80
                                                    });
                                                } else {
                                                    window.location
                                                        .href =
                                                        "Index.html";
                                                    history
                                                        .go(
                                                            0
                                                        );
                                                }
                                            });
                                    }, 1200);
                                }, 5000);
                            } else {
                                done();
                                //console.log(2);
                            }
                        }
                    }).then(action => {
                        /* this.$message({
                            type: 'success',
                            message: "The update is successful"
                        }); */
                    }).catch(() => {
                        console.log(1);
                    });
                });

                return false;
            } else {

                //停止更新扩普
                //添加节点
                //连线
                var obj = {
                    "data": JSON.stringify([{
                        adr: 299,
                        value: "0"
                    }]),
                    "action": "SET"
                }
                /*   util.postattrajax1(obj, function (data) {
                      if ("success" != data) {
                          toast.$message({
                              message: ' Error:' + data.message,
                              type: 'error',
                              showClose: true,
                              offset: 80
                          });
                      } else {
                          //  window.location.href = "Index.html";
                      }
                  }); */

                //初始化节点 
                SitesDataPoll(TopoNull, data.sites, g_sitesNode.sites);
                /* //告警 */
                let Heliosalarm;
                /*   $.getJSON('topology_alarm.json?verisn=' + Herandom + ')', 
                function (Data) {*/
                let Data = {
                    "sites": [{
                        "site_no": "01343d18",
                        "alarm": "1",
                        "device": [{
                                "device_id": "0200",
                                "alarm": "1"
                            },
                            {
                                "device_id": "0246",
                                "alarm": "1"
                            }
                        ]
                    }]
                }

                SitesAlarm(g_sitesNode.sites, Data.sites);
                /*   }); */
                scene.clear();

                SitesTopoNodeAdd(g_sitesNode.sites); //添加括普节点
                SitesTopoNodeLink(g_sitesNode.sites); //连线

                // vm.siteInfo = SiteNode_exist;
                stage.paint();
            }
            /*     }
            }); */
        }
        //进制转换
        function hex2int(hex) {
            var len = hex.length,
                a = new Array(len),
                code;
            for (var i = 0; i < len; i++) {
                code = hex.charCodeAt(i);
                if (48 <= code && code < 58) {
                    code -= 48;
                } else {
                    code = (code & 0xdf) - 65 + 10;
                }
                a[i] = code;
            }
            return a.reduce(function (acc, c) {
                acc = 16 * acc + c;
                return acc + "";
            }, 0);
        }

        //赋值
        function Site_Datefit(m_sitenode, item) {
            //双击
            m_sitenode.setSize(25, 25);
            setTimeout(function () {
                if (item.type == "AU") {
                    if (item.alarm == 0) {
                        m_sitenode.setImage('assets/images/au.png', true);
                    } else {
                        m_sitenode.setImage('assets/images/aualarm.png', true);
                    }
                }
                if (item.type == "EU") {
                    if (item.alarm == 0) {
                        m_sitenode.setImage('assets/images/eu.png', true);
                    } else {
                        m_sitenode.setImage('assets/images/eualarm.png', true);
                    }
                }
                if (item.type == "RU") {
                    if (item.alarm == 0) {
                        m_sitenode.setImage('assets/images/ru.png', true);
                    } else {
                        m_sitenode.setImage('assets/images/rualarm.png', true);
                    }
                }
            }, 500);

            m_sitenode.x = parseInt(item.x / 1000 * CanvasWin_width);
            m_sitenode.y = parseInt(item.y / 1000 * CanvasWin_height);
            m_sitenode.setLocation(m_sitenode.x, m_sitenode.y);
            m_sitenode.site_no = item.site_no;
            // m_sitenode.id = item.id;
            m_sitenode.offline = item.offline;
            m_sitenode.station = item.station;
            m_sitenode.route = item.route;
            m_sitenode.device_id = item.device_id;
            m_sitenode.type = item.type;
            let MDOTS = JSON.parse(localStorage.getItem("MDOTS"));

            m_sitenode.addEventListener("dbclick", function (event, i) {
                var tagurl = (item.type).toLowerCase();
                sessionStorage.setItem("url", "Status");
                sessionStorage.setItem("equipment", tagurl);


                let data = [];
                let obj1 = {
                    adr: 83,
                    value: hex2int(item.device_id)
                };
                data.push(obj1);

                data.push({
                    adr: 82,
                    value: hex2int(item.site_no) //MDOTS[0].value
                });
                localStorage.setItem("MDOTS", JSON.stringify(data));

                var obj = {
                    "data": JSON.stringify(data),
                    "action": "SET"
                }
                util.postattrajax(obj, function (data) {
                    if (1 != data) {
                        util.error('Error' + data.message);
                    } else {
                        setTimeout(function () {
                            window.location.href = "Status.html";
                        }, 500);
                    }
                });
            });

            //右键
            if (Helios.$data.heliosUser) {
                m_sitenode.mouseup(function (event, e) {
                    if (2 == event.button) {
                        if ("AU" == item.type) {

                        }
                        const h = toast.$createElement;
                        toast.$msgbox({
                            title: `M - DOTS Topology`,
                            message: h('p', null, [
                                h('p', {
                                        style: 'color: teal'
                                    }, `Whether or not to delete : ` + (item.type).toUpperCase() +
                                    "    -   " + hex2int(item.device_id))
                            ]),

                            showCancelButton: true,
                            confirmButtonText: 'Confirm',
                            cancelButtonText: 'Cancel',
                            beforeClose: (action, instance, done) => {
                                if (action === 'confirm') {
                                    instance.confirmButtonLoading = true;
                                    instance.confirmButtonText = 'The execution of...';
                                    setTimeout(() => {
                                        done();
                                        instance.confirmButtonLoading = false;
                                        window.location.href = "Index.html";
                                    }, 1000);

                                    let data = [];
                                    let obj1 = {
                                        adr: 298,
                                        value: hex2int(item.site_no) + "," + hex2int(item.device_id)
                                    };
                                    data.push(obj1);

                                    var obj = {
                                        "data": JSON.stringify(data),
                                        "action": "SET"
                                    }
                                    util.postattrajax(obj, function (data) {
                                        if (1 != data) {
                                            util.error('Error' + data.message);
                                        } else {
                                            setTimeout(function () {
                                                window.location.href =
                                                    "Index.html";
                                            }, 500);
                                        }
                                    });

                                } else {
                                    done();
                                    //取消
                                    console.log(1);
                                }
                            }
                        }).then(action => {
                            //确定
                            console.log(2);
                        }).catch(() => {
                            //取消
                            console.log(1);
                        });

                    }

                });
            }
        }


        Helios = new Vue({
            el: "#content",
            data: data,
            mounted() {
                $("body").resize();
                Canvas_Init();
                GetStation(this);

            },

            methods: {
                //坐标
                SetCoordinates: function () {
                    /*  console.log(vm.siteInfo); */
                    Helios.$data.Read = false;
                    // var obj = {};
                    var params = [];

                    let sites = g_sitesNode.sites;
                    let devices;
                    for (let i = 0; i < g_sitesNode.sites.length; i++) {

                        let site = {};
                        site.site_no = sites[i].site_no;
                        site.x = parseInt(sites[i].node.x * 1000 / CanvasWin_width).toString();
                        site.y = parseInt(sites[i].node.y * 1000 / CanvasWin_height).toString();
                        site.status = 1;
                        site.device = [];
                        params.push(site);
                        devices = g_sitesNode.sites[i].devices;
                        for (let j = 0; j < devices.length; j++) {
                            let device = {};
                            device.route = devices[j].route;
                            device.device_id = devices[j].device_id;
                            device.type = devices[j].type;
                            device.x = parseInt(devices[j].node.x * 1000 / CanvasWin_width).toString();
                            device.y = parseInt(devices[j].node.y * 1000 / CanvasWin_height).toString();
                            site.device.push(device);
                        }
                    }
                    var heliosThre = {
                        "sites": params
                    }
                    $.ajax({
                        url: `cgi-bin/doaction.cgi`,
                        data: {
                            "action": "STATION_SAVE",
                            "stationInfo": JSON.stringify(heliosThre),
                        },
                        type: "post",
                        dataType: "json",
                        success: function (data, status) {},
                        error: function (req, status, err) {
                            localStorage.setItem("TopoNull", 1);
                            util.success('success');
                            setTimeout(function () {
                                window.location.href = "Index.html";
                                Helios.$data.Read = true;
                            }, 1200);
                        }
                    });
                },

                //背景图
                fileImport() {
                    var selectedFile = "";
                    var temp = [];
                    var obj = {};
                    selectedFile = document.getElementById('files').files[0];
                    if (undefined == selectedFile) {
                        toast.$notify({
                            title: 'warning',
                            message: 'Please select file',
                            type: 'warning'
                        });
                        return false;
                    } else {
                        let suffix = selectedFile.name;
                        if ("background.jpg" != suffix) {
                            toast.$notify({
                                title: 'warning',
                                message: 'Please set the filename to【background.jpg】',
                                type: 'warning'
                            });
                            return false;
                        } else {

                        }
                    }

                    Helios.$data.Read = false;

                    let fileForm = document.getElementById("fileForm"); // 获取整个form表单数据,记住input都需要name属性
                    let url = "../cgi-bin/doaction.cgi" // 上传服务器接口

                    let formData = new FormData(fileForm);


                    formData.append("action", "ImageSet");
                    formData.append("filename", selectedFile);
                    formData.append("data", JSON.stringify(temp));


                    $.ajax({
                        url: url,
                        data: formData,
                        /* data: formData.get('filename'), */
                        /* data: JSON.stringify(temp), */
                        type: "post",
                        processData: false,
                        contentType: false,

                        success: function (data, status) {
                            /* console.log(data);
                            console.log(status); */
                            var data = JSON.parse(data);
                            if (data.code == 1) {
                                Helios.$data.Read = true;
                                toast.$notify({
                                    title: 'success',
                                    message: '',
                                    type: 'success'
                                });

                                setTimeout(function () {
                                    window.location.href = "Index.html";
                                }, 1000);
                            } else {
                                Helios.$data.Read = true;
                                toast.$notify({
                                    title: 'warning',
                                    message: 'Update failed',
                                    type: 'warning'
                                });
                            }
                        },
                        error: function (req, status, err) {

                        }
                    });
                },
                // 取消form表单的自动提交功能
                onSubmit() {
                    return false;
                },

                //更新括普
                UpdateTopology() {

                    const h = toast.$createElement;
                    toast.$msgbox({
                        title: `Update M-DOTS Topology`,
                        message: h('p', null, [
                            h('span', null,
                                "Updating the topology"
                            ),
                            h('p', {
                                style: 'color: teal'
                            }, "Take five to ten seconds")
                        ]),
                        showCancelButton: true,
                        confirmButtonText: 'Confirm',
                        cancelButtonText: 'Cancel',
                        beforeClose: (action, instance, done) => {
                            if (action === 'confirm') {
                                instance.confirmButtonLoading = true;
                                instance.confirmButtonText = 'The execution of...';

                                var obj = {
                                    "data": JSON.stringify([{
                                        adr: 299,
                                        value: "1"
                                    }]),
                                    "action": "SET"
                                }
                                util.postattrajax1(obj, function (data) {
                                    if ("success" != data) {
                                        toast.$message({
                                            message: ' Error:' + data.message,
                                            type: 'error',
                                            showClose: true,
                                            offset: 80
                                        });
                                    } else {

                                    }
                                });

                                setTimeout(() => {
                                    done();
                                    instance.confirmButtonLoading = false;
                                    setTimeout(() => {
                                        var obj = {
                                            "data": JSON.stringify([{
                                                adr: 299,
                                                value: "0"
                                            }]),
                                            "action": "SET"
                                        }
                                        util.postattrajax1(obj, function (data) {
                                            if ("success" != data) {
                                                toast.$message({
                                                    message: ' Error:' +
                                                        data.message,
                                                    type: 'error',
                                                    showClose: true,
                                                    offset: 80
                                                });
                                            } else {
                                                window.location.href =
                                                    "Index.html";
                                                history.go(0);
                                            }
                                        });
                                    }, 1500);
                                }, 5000);
                            } else {
                                done();

                            }
                        }
                    }).then(action => {

                    }).catch(() => {

                    });

                }
            },
        });
    </script>
    <style>
        .updatetopology {
            margin-bottom: 4px;
        }

        .updatetopology .el-button {
            width: 166px;
        }

        #Update_Topology {
            margin-top: 10px;
        }

        .a-upload {
            position: relative;
            cursor: pointer;
            background: #5daf34;
            color: #fff;
            border: 1px solid #5daf34;
            border-radius: 4px;
            overflow: hidden;
            display: inline-block;
            transition: .1s;
            font-weight: 500;
            padding: 10.5px 20px;
            font-size: 14px;
            border-radius: 4px;
        }

        .a-upload input {
            position: absolute;
            font-size: 9px;
            right: 0;
            top: 0;
            opacity: 0;
            filter: alpha(opacity=0);
            cursor: pointer;
            z-index: 555;
            width: 100%;
            height: 37px;
            z-index: 66;
        }

        .a-upload:hover {
            background: #85ce61;
            border-color: #85ce61;
            color: #fff;
        }
    </style>

</body>


</html>